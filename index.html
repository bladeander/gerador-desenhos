<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Desenhos Fofos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-pink-50 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-2xl">
        <div class="bg-white rounded-2xl shadow-lg p-6 sm:p-8 text-center">
            
            <!-- Cabeçalho -->
            <h1 class="text-3xl sm:text-4xl font-bold text-pink-500 mb-2">Gerador de Desenhos Fofos</h1>
            <p class="text-gray-500 mb-6 text-lg">Para Colorir</p>

            <!-- Formulário de Entrada -->
            <div class="mb-4">
                <input type="text" id="userInput" class="w-full px-4 py-3 border-2 border-pink-200 rounded-lg focus:ring-2 focus:ring-pink-400 focus:border-transparent outline-none transition" placeholder="Digite um tema em português (ex: cãozinho a brincar na chuva)">
            </div>

            <!-- Botão de Gerar -->
            <button id="generateBtn" class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105 shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed disabled:transform-none">
                Gerar Desenho
            </button>

            <!-- Área de Geração da Imagem -->
            <div id="imageContainer" class="mt-8 p-4 border-2 border-dashed border-pink-200 rounded-2xl min-h-[300px] sm:min-h-[400px] flex justify-center items-center bg-pink-50/50">
                <div id="placeholder" class="text-gray-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <p>O seu desenho para colorir aparecerá aqui!</p>
                </div>
                <div id="loader" class="hidden flex-col items-center justify-center">
                    <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-12 w-12 mb-4"></div>
                    <p class="text-gray-500">A traduzir e a desenhar algo bem giro...</p>
                </div>
                <img id="generatedImage" class="hidden max-w-full max-h-full rounded-lg" alt="Desenho gerado pelo utilizador para colorir">
            </div>
            
            <!-- Botão de Download -->
            <a id="downloadBtn" href="#" class="hidden mt-4 inline-block bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 shadow-md">
                Descarregar Desenho
            </a>

        </div>
    </div>

 <script>
    // Seleciona os elementos da página
    const generateBtn = document.getElementById('generateBtn');
    const userInput = document.getElementById('userInput');
    const imageContainer = document.getElementById('imageContainer');
    const placeholder = document.getElementById('placeholder');
    const loader = document.getElementById('loader');
    const generatedImage = document.getElementById('generatedImage');
    const downloadBtn = document.getElementById('downloadBtn');

    // Adiciona o evento de clique ao botão
    generateBtn.addEventListener('click', generateImage);
    
    // Permite gerar com a tecla Enter
    userInput.addEventListener('keyup', (event) => {
        if (event.key === 'Enter') {
            generateImage();
        }
    });

    // Função principal para gerar a imagem
    async function generateImage() {
        const userPrompt = userInput.value.trim();
        if (!userPrompt) {
            alert('Por favor, digite um tema para o desenho.');
            return;
        }

        setLoading(true);

        try {
            // Passo 1: Chamar a NOSSA função de tradução no backend
            const translateResponse = await fetch('/.netlify/functions/translate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ textToTranslate: userPrompt })
            });
            if (!translateResponse.ok) throw new Error('Falha ao contactar o servidor de tradução.');
            const { translatedText } = await translateResponse.json();

            // Passo 2: Chamar a NOSSA função de geração de imagem no backend
            const imageResponse = await fetch('/.netlify/functions/generate-image', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: translatedText })
            });
            if (!imageResponse.ok) throw new Error('Falha ao contactar o servidor de imagem.');
            const result = await imageResponse.json();
            
            // Passo 3: Processar a resposta e exibir a imagem
            if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                generatedImage.src = imageUrl;
                downloadBtn.href = imageUrl;
                downloadBtn.download = `desenho_fofo_${userPrompt.replace(/\s+/g, '_')}.png`;
                
                generatedImage.classList.remove('hidden');
                downloadBtn.classList.remove('hidden');
                placeholder.classList.add('hidden');
            } else {
                throw new Error('A resposta do servidor não continha uma imagem válida.');
            }

        } catch (error) {
            console.error('Erro no processo:', error);
            placeholder.innerHTML = `<p class="text-red-500">Ops! Algo deu errado. Por favor, tente novamente.</p>`;
            placeholder.classList.remove('hidden');
        } finally {
            setLoading(false);
        }
    }

    // Função para controlar o estado de carregamento da UI
    function setLoading(isLoading) {
        generateBtn.disabled = isLoading;
        if (isLoading) {
            generatedImage.classList.add('hidden');
            downloadBtn.classList.add('hidden');
            placeholder.classList.add('hidden');
            loader.classList.remove('hidden');
            generateBtn.innerText = 'A gerar...';
        } else {
            loader.classList.add('hidden');
            generateBtn.innerText = 'Gerar Desenho';
        }
    }
</script>
</body>
</html>
